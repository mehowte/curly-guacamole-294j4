# README

## Setup

### Ruby, Node.js

Make sure you have ruby and nodejsinstalled, with versions specified in `.tools-versions`

On MacOS I recommend using `asdf` to install them.

```sh
asdf install ruby 3.2.2
asdf install nodejs 16.17.0
```

### Env variables

Copy `.env.example` to `.env.local` and fill it with appropriate environment variables.

- OPENAI_API_KEY - your openai access token (https://platform.openai.com/account/api-keys)
- RESEMBLE_API_KEY - your resemble.ai access token (https://app.resemble.ai/account/api)
- RESEMBLE_VOICE_ID - one of the voice uuids available on your account (find them here: https://docs.app.resemble.ai/docs/resource_voice/all)
- RESEMBLE_PROJECT_ID - one of your project uuids available on your account, clips will be stored there (find projects here https://docs.app.resemble.ai/docs/resource_project/all)
- BASE_URL - useful to test audio file generation in localhost. Point it to your ngrok url so the app can receive external webhooks from resemble.ai. Otherwise set it to localhost:3000.

### Database setup

Create dev and test database

```sh
bin/rails db:create
```

### Static files setup

Copy `book.pdf`, `book.pdf.embeddings.csv` and `book.pdf.pages.csv` to `static_files` dir.

## Testing

Nothing special. Just run the following command.

```sh
 bin/rails test
```

## Local development

Start Vite dev server

```sh
bin/vite dev
```

Start Rails server

```sh
bin/rails s
```

## Deployment

### Heroku Setup

```sh
heroku apps:create --stack=heroku-22
```

#### Set environment variables

```sh
heroku config:set BASE_URL=<your autogenerated heroku url> OPENAI_API_KEY=<your open ai access token> OTHER_VARIABLES=OTHER_VALUES
```

Required for JS generation by Vite

```sh
heroku config:set NPM_CONFIG_INCLUDE='dev' YARN_PRODUCTION=false
```

#### Add buildpacks

Required for Vite to run in this order.

```sh
heroku buildpacks:set heroku/ruby
heroku buildpacks:add --index 1 heroku/nodejs
```

#### First Deployment

```sh
git push heroku main
heroku run rails db:migrate
```

## Generate and upload Data files.

1. put file called `book.pdf` in `static_files/`

2. Generate pages and embeddings from pdf

```sh
bin/rails book:process
```

3. Create a separate branch e.g. book

```sh
git checkout -b book
git add static_files/book.pdf.pages.csv static_files/book.pdf.embeddings.csv --force
git commit -m "Add static files"
```

4. Deploy branch

```sh
git push heroku book:main --force
```
